import{r,j as e,a as D}from"./index-DZNekYFt.js";import{n as g,d as k,T as C,m as E,r as L,a as S,b as z,c as O,L as A,F as T,D as I}from"./resizeResults-GGqK0wwp.js";const B=({onRegister:h,onCancel:b})=>{const s=r.useRef(null),a=r.useRef(null),[l,u]=r.useState(""),[d,o]=r.useState(""),[i,f]=r.useState(!1),[y,v]=r.useState(""),j=async()=>{const t="/models";await Promise.all([g.tinyFaceDetector.loadFromUri(t),g.faceLandmark68Net.loadFromUri(t),g.faceRecognitionNet.loadFromUri(t)])};r.useEffect(()=>{j()},[]);const R=async()=>{const t=await navigator.mediaDevices.getUserMedia({video:{}});s.current&&(s.current.srcObject=t,f(!0)),setTimeout(()=>n(),1e3)},N=()=>{var t,m,c;(t=s.current)!=null&&t.srcObject&&s.current.srcObject.getTracks().forEach(p=>p.stop()),f(!1),(c=(m=a.current)==null?void 0:m.getContext("2d"))==null||c.clearRect(0,0,640,480)},n=async()=>{var p;if(!s.current||!a.current)return;const t=s.current,m=await k(t,new C).withFaceLandmarks().withFaceDescriptor(),c=a.current,x={width:t.width,height:t.height};if(E(c,x),(p=c.getContext("2d"))==null||p.clearRect(0,0,c.width,c.height),m){const w=L(m,x);S(c,w),z(c,w);const M=w.landmarks.getLeftEye(),U=w.landmarks.getRightEye();Math.abs(M[0].x-U[3].x)>=40?v("✅ Angle OK"):v("❌ Face the camera directly.")}else v("❌ No face detected.");i&&setTimeout(()=>n(),300)},F=async()=>{if(!s.current)return;const t=await k(s.current,new C).withFaceLandmarks().withFaceDescriptor();if(!t){alert("No face detected.");return}const m=t.landmarks.getLeftEye(),c=t.landmarks.getRightEye();if(Math.abs(m[0].x-c[3].x)<40){alert("Face the camera directly.");return}const p=Array.from(t.descriptor),w=await D.post("http://localhost:3000/api/image",{firstName:l,lastName:d,descriptor:p});h(w.data),u(""),o(""),N()};return e.jsxs("div",{className:"max-w-3xl mx-auto p-6 space-y-6 bg-white shadow-xl rounded-xl mt-10",children:[e.jsx("h2",{className:"text-2xl font-bold text-center",children:"Register New Face"}),e.jsx("div",{className:"flex justify-center gap-4",children:i?e.jsx("button",{onClick:N,className:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition",children:"Close Camera"}):e.jsx("button",{onClick:R,className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition",children:"Open Camera"})}),e.jsxs("div",{className:"relative w-full max-w-xl mx-auto aspect-video border rounded overflow-hidden",children:[e.jsx("video",{ref:s,width:"640",height:"480",autoPlay:!0,muted:!0,className:"absolute top-0 left-0 w-full h-full object-cover"}),e.jsx("canvas",{ref:a,width:"640",height:"480",className:"absolute top-0 left-0 w-full h-full"})]}),e.jsx("p",{className:"text-center font-medium text-gray-700",children:y}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx("input",{type:"text",placeholder:"First name",value:l,onChange:t=>u(t.target.value),className:"border px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-400"}),e.jsx("input",{type:"text",placeholder:"Last name",value:d,onChange:t=>o(t.target.value),className:"border px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-400"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 justify-center mt-4",children:[e.jsx("button",{onClick:F,disabled:!l||!d,className:`px-6 py-2 rounded text-white transition ${l&&d?"bg-green-600 hover:bg-green-700":"bg-gray-400 cursor-not-allowed"}`,children:"Register"}),e.jsx("button",{onClick:b,className:"px-6 py-2 rounded bg-gray-300 hover:bg-gray-400 transition",children:"Cancel"})]})]})},P=({faces:h,onRegisterClick:b})=>{const s=r.useRef(null),a=r.useRef(null),[l,u]=r.useState(null);return r.useEffect(()=>((async()=>{const o=await navigator.mediaDevices.getUserMedia({video:{}});s.current&&(s.current.srcObject=o)})(),()=>{var o;(o=s.current)!=null&&o.srcObject&&s.current.srcObject.getTracks().forEach(f=>f.stop())}),[]),r.useEffect(()=>{if(!s.current||!a.current||h.length===0)return;const d={width:s.current.width,height:s.current.height};E(a.current,d);const i=setInterval(async()=>{var N;const f=await O(s.current).withFaceLandmarks().withFaceDescriptors(),y=L(f,d);(N=a.current.getContext("2d"))==null||N.clearRect(0,0,a.current.width,a.current.height),S(a.current,y);const v=h.map(n=>new A(`${n.firstName} ${n.lastName}`,[new Float32Array(n.descriptor)])),j=new T(v,.6);y.map(n=>j.findBestMatch(n.descriptor)).forEach((n,F)=>{const t=y[F].detection.box;if(new I(t,{label:n.toString()}).draw(a.current),n.label!=="unknown"){const[c,x]=n.label.split(" ");u({firstName:c,lastName:x})}else u(null)})},500);return()=>clearInterval(i)},[h]),e.jsxs("div",{className:"flex flex-col items-center justify-center p-4 space-y-4",children:[e.jsxs("div",{className:"relative w-full max-w-[720px] aspect-video border rounded-xl overflow-hidden shadow-md",children:[e.jsx("video",{ref:s,width:"720",height:"560",autoPlay:!0,muted:!0,playsInline:!0,className:"w-full h-full object-cover"}),e.jsx("canvas",{ref:a,width:"720",height:"560",className:"absolute top-0 left-0 w-full h-full"})]}),l?e.jsxs("h3",{className:"text-green-600 text-lg font-semibold",children:["Recognized: ",l.firstName," ",l.lastName]}):e.jsx("p",{className:"text-gray-500",children:"No recognized face detected"}),e.jsx("button",{onClick:b,className:"bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-200",children:"Register New Face"})]})},q=()=>{const[h,b]=r.useState(!0),[s,a]=r.useState([]),[l,u]=r.useState(!1);r.useEffect(()=>{(async()=>{try{await Promise.all([g.tinyFaceDetector.loadFromUri("/models"),g.faceLandmark68Net.loadFromUri("/models"),g.faceRecognitionNet.loadFromUri("/models"),g.ssdMobilenetv1.loadFromUri("/models")]);const{data:i}=await D.get("http://localhost:3000/api/image");a(i),b(!1)}catch(i){console.error("Initialization error:",i)}})()},[]),console.log(s);const d=o=>{a(i=>[...i,o])};return e.jsxs("div",{style:{padding:20},children:[e.jsx("h1",{children:"Face Recognition System"}),h?e.jsx("p",{children:"Loading models..."}):l?e.jsx(B,{onRegister:d,onCancel:()=>u(!1)}):e.jsx(P,{faces:s,onRegisterClick:()=>u(!0)})]})};export{q as default};
